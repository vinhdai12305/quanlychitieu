<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoneyKeeper - B√°o c√°o & Ph√¢n t√≠ch</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // QUAN TR·ªåNG: T·∫Øt preflight ƒë·ªÉ kh√¥ng l√†m h·ªèng giao di·ªán c≈©
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        emerald: {
                            50: '#ecfdf5',
                            500: '#10b981',
                            600: '#059669',
                        }
                    }
                }
            },
            corePlugins: {
                preflight: false, 
            }
        }
    </script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        /* 4. CSS T√ôY CH·ªàNH CHO PH·∫¶N N·ªòI DUNG (Gi·ªØ nguy√™n style ƒë·∫πp c≈©) */
        :root { 
            --bg: #f8fafc; 
            --card: #ffffff; 
            --primary: #10b981; /* ƒê√£ ch·ªânh theo m√†u Emerald c·ªßa Header */
            --danger: #ef4444; 
            --info: #3b82f6; 
            --text: #1e293b; 
            --text-light: #64748b; 
        }

        body { background-color: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
        
        /* Container ch√≠nh */
        .dashboard-container { max-width: 1300px; margin: auto; padding: 30px 20px; }

        /* C√°c th√†nh ph·∫ßn Grid & Card */
        .report-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .report-header h1 { font-size: 1.8rem; font-weight: 700; margin: 0; }
        
        .styled-select { padding: 10px 15px; border-radius: 10px; border: 1px solid #e2e8f0; font-weight: 600; cursor: pointer; outline: none; font-family: 'Inter', sans-serif; background: white; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .stat-card, .main-chart-card, .sub-card { background: var(--card); border-radius: 20px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.02); }
        .stat-card h2 { margin: 10px 0; font-size: 28px; font-weight: 700; }
        .stat-card p { margin: 0; color: var(--text-light); font-size: 14px; font-weight: 600; text-transform: uppercase; }

        .main-chart-card { margin-top: 25px; }
        .chart-wrapper { height: 350px; margin-top: 20px; position: relative; }
        
        .bottom-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 25px; }
        
        /* Progress & List Styles */
        .cat-item { margin-top: 20px; }
        .cat-info { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
        .progress { background: #f1f5f9; height: 10px; border-radius: 10px; }
        .bar { height: 100%; border-radius: 10px; }
        .bar.blue { background: var(--info); } .bar.yellow { background: #f5a623; }
        .dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 5px; } .dot.blue { background: var(--info); } .dot.yellow { background: #f5a623; }
        
        .transaction { display: flex; align-items: center; margin-top: 20px; padding-bottom: 10px; border-bottom: 1px solid #f1f5f9; }
        .transaction:last-child { border-bottom: none; }
        .tx-icon { background: #f1f5f9; padding: 10px; border-radius: 12px; margin-right: 15px; font-size: 20px; }
        .tx-details strong { display: block; font-size: 14px; }
        .tx-details span { font-size: 12px; color: var(--text-light); }
        .tx-amount { margin-left: auto; font-weight: 600; font-size: 14px; }
        .tx-amount.negative { color: var(--text); }

        /* Responsive */
        @media (max-width: 768px) { 
            .stats-grid, .bottom-grid { grid-template-columns: 1fr; } 
        }

        /* --- POPUP (MODAL) --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 20px; width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h3 { margin: 0; font-size: 1.2rem; font-weight: 700; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 14px; font-weight: 500; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; box-sizing: border-box; }
        .btn-submit { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 10px; transition: 0.2s; }
        .btn-submit:hover { opacity: 0.9; }
        .btn-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #999; }
    </style>
</head>
<body>

    <nav class="bg-white shadow-sm px-6 py-4 flex justify-between items-center sticky top-0 z-50">
        <div class="flex items-center gap-2 font-bold text-xl text-gray-800 cursor-pointer">
            <span class="bg-gray-900 text-white px-2 py-1 rounded-md text-sm">MK</span>
            <span>Money Keeper</span>
        </div>
    
        <div class="hidden md:flex items-center gap-6 text-sm font-medium text-gray-600">
            <a href="#" class="hover:text-emerald-600 transition">T·ªïng quan</a>
            <a href="#" class="hover:text-emerald-600 transition">Chi ti√™u</a>
            <a href="#" class="hover:text-emerald-600 transition">Thu nh·∫≠p</a>
            <a href="#" class="hover:text-emerald-600 transition">Ng√¢n s√°ch</a>
            <a href="#" class="px-4 py-2 rounded-lg bg-emerald-50 text-emerald-600 font-semibold">B√°o c√°o</a>
            <a href="#" class="hover:text-emerald-600 transition">C√†i ƒë·∫∑t</a>
        </div>
    
        <div class="flex items-center gap-4">
            <button onclick="openModal()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg font-medium transition text-sm flex items-center gap-2">
                <span>+</span>
                <span class="hidden sm:inline">Th√™m m·ªõi</span>
            </button>
    
            <div class="flex items-center gap-3 border-l border-gray-200 pl-4">
                <div class="text-right hidden sm:block leading-tight">
                    <div class="text-sm font-semibold text-gray-900">Nguy·ªÖn VƒÉn A</div>
                    <div class="text-xs text-gray-500">Premium</div>
                </div>
                <div class="w-9 h-9 rounded-full bg-emerald-600 text-white flex items-center justify-center font-semibold text-sm">NA</div>
            </div>
        </div>
    </nav>

    <div class="dashboard-container">
        
        <header class="report-header">
            <h1>Ph√¢n t√≠ch t√†i ch√≠nh</h1>
            <div class="filter-box">
                <select id="periodSelect" class="styled-select" onchange="updateDashboard()">
                    <option value="current">Th√°ng n√†y</option>
                    <option value="previous">Th√°ng tr∆∞·ªõc</option>
                </select>
            </div>
        </header>

        <section class="stats-grid">
            <div class="stat-card">
                <p>T·ªïng thu nh·∫≠p</p>
                <h2 id="incomeVal">...</h2>
            </div>
            <div class="stat-card">
                <p>T·ªïng chi ti√™u</p>
                <h2 id="expenseVal">...</h2>
            </div>
            <div class="stat-card">
                <p>S·ªë d∆∞ kh·∫£ d·ª•ng</p>
                <h2 id="balanceVal">...</h2>
            </div>
        </section>

        <section class="main-chart-card">
            <div class="report-header" style="margin-bottom: 0;">
                <h3 style="font-size: 1.2rem; margin: 0;">D√≤ng ti·ªÅn</h3>
                <p style="margin: 0; font-size: 0.9rem; color: #64748b;">Thu nh·∫≠p vs Chi ti√™u <span id="periodLabel">...</span></p>
            </div>
            <div class="chart-wrapper">
                <canvas id="flowChart"></canvas>
            </div>
        </section>

        <div class="bottom-grid">
            <div class="sub-card">
                <h3 style="font-size: 1.2rem; margin-bottom: 20px;">Ph√¢n lo·∫°i Chi ti√™u</h3>
                <div class="cat-list"></div>
            </div>
            <div class="sub-card">
                <h3 style="font-size: 1.2rem; margin-bottom: 20px;">Giao d·ªãch g·∫ßn ƒë√¢y</h3>
                <div class="tx-list"></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="addModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Th√™m Giao d·ªãch</h3>
                <button class="btn-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="form-group">
                <label>Lo·∫°i giao d·ªãch</label>
                <select id="inpType" class="form-control">
                    <option value="expense">Chi ti√™u (Expense)</option>
                    <option value="income">Thu nh·∫≠p (Income)</option>
                </select>
            </div>
            <div class="form-group">
                <label>S·ªë ti·ªÅn (VNƒê)</label>
                <input type="number" id="inpAmount" class="form-control" placeholder="V√≠ d·ª•: 50000">
            </div>
            <div class="form-group">
                <label>Danh m·ª•c</label>
                <select id="inpCategory" class="form-control">
                    <option value="ƒÇn u·ªëng">ƒÇn u·ªëng</option>
                    <option value="Mua s·∫Øm">Mua s·∫Øm</option>
                    <option value="Nh√† ·ªü">Nh√† ·ªü</option>
                    <option value="Di chuy·ªÉn">Di chuy·ªÉn</option>
                    <option value="L∆∞∆°ng">L∆∞∆°ng</option>
                    <option value="Gi·∫£i tr√≠">Gi·∫£i tr√≠</option>
                </select>
            </div>
            <div class="form-group">
                <label>Ng√†y</label>
                <input type="date" id="inpDate" class="form-control">
            </div>
            <div class="form-group">
                <label>Ghi ch√∫</label>
                <input type="text" id="inpNote" class="form-control" placeholder="Ghi ch√∫...">
            </div>
            <button class="btn-submit" onclick="saveTransaction()">L∆∞u l·∫°i</button>
        </div>
    </div>
    
    <script>
        // --- 1. C·∫§U H√åNH FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDiDIFKqm5e_g7MrUMWGTcTvjOtoNhj2GA",
            authDomain: "quanlichitieu-c30b4.firebaseapp.com",
            projectId: "quanlichitieu-c30b4",
            storageBucket: "quanlichitieu-c30b4.firebasestorage.app",
            messagingSenderId: "385297935024",
            appId: "1:385297935024:web:26a01ca43a3d6cbc3de975",
            measurementId: "G-7MQX3Z2ZWL"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let myChart;

        // --- 2. X·ª¨ L√ù POPUP ---
        function openModal() {
            document.getElementById('addModal').style.display = 'flex';
            document.getElementById('inpDate').valueAsDate = new Date();
        }
        function closeModal() {
            document.getElementById('addModal').style.display = 'none';
        }

        // --- 3. L∆ØU D·ªÆ LI·ªÜU ---
        async function saveTransaction() {
            const type = document.getElementById('inpType').value;
            const amount = Number(document.getElementById('inpAmount').value);
            const category = document.getElementById('inpCategory').value;
            const note = document.getElementById('inpNote').value;
            const dateStr = document.getElementById('inpDate').value;

            if (!amount || !dateStr) { alert("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!"); return; }

            const dateObj = new Date(dateStr); 

            try {
                await db.collection("transactions").add({
                    amount: amount, category: category, date: dateObj, note: note, type: type
                });
                alert("ƒê√£ l∆∞u th√†nh c√¥ng!");
                closeModal();
                updateDashboard(); // C·∫≠p nh·∫≠t l·∫°i ngay
                document.getElementById('inpAmount').value = '';
                document.getElementById('inpNote').value = '';
            } catch (error) {
                console.error(error); alert("L·ªói khi l∆∞u!");
            }
        }

        // --- 4. BI·ªÇU ƒê·ªí & DATA ---
        function initChart() {
            const ctx = document.getElementById('flowChart').getContext('2d');
            const greenGradient = ctx.createLinearGradient(0, 0, 0, 300);
            greenGradient.addColorStop(0, 'rgba(16, 185, 129, 0.2)'); // M√†u Emerald
            greenGradient.addColorStop(1, 'rgba(16, 185, 129, 0)');

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Thu nh·∫≠p', data: [], borderColor: '#10b981', backgroundColor: greenGradient, fill: true, tension: 0.4
                    }, {
                        label: 'Chi ti√™u', data: [], borderColor: '#ef4444', fill: false, tension: 0.4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { display: false }, x: { grid: { display: false } } } }
            });
        }

        async function fetchRealData(month, year) {
            console.log(`L·∫•y data T${month}/${year}`);
            const start = new Date(year, month - 1, 1);
            const end = new Date(year, month, 0, 23, 59, 59);

            const q = db.collection("transactions")
                .where("date", ">=", start)
                .where("date", "<=", end);

            try {
                const querySnapshot = await q.get();
                let totalIncome = 0; let totalExpense = 0;
                let dailyData = {}; let categories = {}; let recentTransactions = [];

                querySnapshot.forEach((doc) => {
                    const t = doc.data();
                    const amount = Number(t.amount) || 0;
                    
                    let dateObj = t.date && t.date.toDate ? t.date.toDate() : new Date(t.date);
                    const day = String(dateObj.getDate()).padStart(2, '0');
                    const dateKey = `${year}-${month}-${day}`;
                    
                    recentTransactions.push({ ...t, jsDate: dateObj, desc: t.note || t.category, displayDate: `${day}/${month}/${year}` });

                    if (t.type === 'income') {
                        totalIncome += amount;
                        if (!dailyData[dateKey]) dailyData[dateKey] = { inc: 0, exp: 0 };
                        dailyData[dateKey].inc += amount;
                    } else {
                        totalExpense += amount;
                        if (!dailyData[dateKey]) dailyData[dateKey] = { inc: 0, exp: 0 };
                        dailyData[dateKey].exp += amount;
                        if (!categories[t.category]) categories[t.category] = 0;
                        categories[t.category] += amount;
                    }
                });

                recentTransactions.sort((a, b) => b.jsDate - a.jsDate);
                return { totalIncome, totalExpense, dailyData, categories, recentTransactions };
            } catch (error) { console.error(error); return null; }
        }

        async function updateDashboard() {
            const period = document.getElementById('periodSelect').value;
            
            // Logic l·∫•y ng√†y hi·ªán t·∫°i
            const today = new Date();
            let year = today.getFullYear();
            let month = today.getMonth() + 1;

            if (period === 'previous') {
                month -= 1;
                if (month === 0) { month = 12; year -= 1; }
            }
            const monthStr = String(month).padStart(2, '0');

            document.getElementById('periodLabel').innerText = `th√°ng ${monthStr}/${year}`;
            
            // Update l·∫°i text trong dropdown
            const options = document.getElementById('periodSelect').options;
            options[0].text = `Th√°ng n√†y (T${today.getMonth() + 1}/${today.getFullYear()})`;
            
            const data = await fetchRealData(monthStr, year);
            if (!data) return;

            document.getElementById('incomeVal').innerText = formatCurrency(data.totalIncome);
            document.getElementById('expenseVal').innerText = formatCurrency(data.totalExpense);
            document.getElementById('balanceVal').innerText = formatCurrency(data.totalIncome - data.totalExpense);

            const sortedDates = Object.keys(data.dailyData).sort();
            myChart.data.labels = sortedDates.map(d => d.split('-')[2]); 
            myChart.data.datasets[0].data = sortedDates.map(d => data.dailyData[d].inc);
            myChart.data.datasets[1].data = sortedDates.map(d => data.dailyData[d].exp);
            myChart.update();

            renderCategories(data.categories, data.totalExpense);
            renderTransactions(data.recentTransactions);
        }

        function formatCurrency(n) { return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(n); }

        function renderCategories(cats, total) {
            const container = document.querySelector('.cat-list'); container.innerHTML = '';
            const sorted = Object.entries(cats).sort((a,b) => b[1] - a[1]);
            if(sorted.length === 0) container.innerHTML = '<p style="color:#999; text-align:center">Ch∆∞a c√≥ d·ªØ li·ªáu</p>';

            sorted.forEach(([name, amt], i) => {
                const pct = total ? Math.round((amt/total)*100) : 0;
                const color = i % 2 === 0 ? 'blue' : 'yellow';
                container.innerHTML += `<div class="cat-item"><div class="cat-info"><span><i class="dot ${color}"></i> ${name}</span><span>${formatCurrency(amt)} <b>${pct}%</b></span></div><div class="progress"><div class="bar ${color}" style="width: ${pct}%;"></div></div></div>`;
            });
        }

        function renderTransactions(txs) {
            const container = document.querySelector('.tx-list'); container.innerHTML = '';
            if(txs.length === 0) container.innerHTML = '<p style="color:#999; text-align:center">Ch∆∞a c√≥ giao d·ªãch</p>';
            
            txs.slice(0, 5).forEach(t => {
                const isExp = t.type !== 'income';
                container.innerHTML += `<div class="transaction"><div class="tx-icon">üõí</div><div class="tx-details"><strong>${t.desc}</strong><span>${t.displayDate}</span></div><span class="tx-amount ${isExp ? 'negative' : ''}">${isExp ? '-' : '+'} ${formatCurrency(t.amount)}</span></div>`;
            });
        }

        document.addEventListener('DOMContentLoaded', () => { initChart(); updateDashboard(); });
    </script>
</body>
</html>