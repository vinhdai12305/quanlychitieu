<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoneyKeeper - B√°o c√°o & Ph√¢n t√≠ch</title>
    <!-- FAVICON -->
    <link rel="icon" type="image/png" href="../assets/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="../assets/favicon.svg" />
    <link rel="shortcut icon" href="../assets/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="../assets/apple-touch-icon.png" />
    <link rel="manifest" href="../assets/site.webmanifest" />

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0"
        rel="stylesheet" />

    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Use default config to ensure compatibility with global modal styles
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        emerald: {
                            50: '#ecfdf5',
                            500: '#10b981',
                            600: '#059669',
                        }
                    }
                }
            }
        }
    </script>



    <link rel="stylesheet" href="../../src/css/style.css">
</head>

<body>

    <div id="header-container" class="sticky top-0 z-50"></div>

    <div class="dashboard-container">

        <header class="flex flex-wrap items-center justify-between gap-4 mb-6">
            <h1 class="text-2xl font-bold text-gray-900">Ph√¢n t√≠ch t√†i ch√≠nh</h1>
            <div id="report-date-picker" class="relative z-40"></div>
        </header>

        <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="stat-card">
                <div class="flex items-center justify-between mb-4">
                    <div class="bg-green-100 p-3 rounded-full">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M7 11l5-5m0 0l5 5m-5-5v12"></path>
                        </svg>
                    </div>
                    <span class="text-xs font-semibold text-green-600 bg-green-50 px-2 py-1 rounded">+ Thu nh·∫≠p</span>
                </div>
                <p class="text-gray-500 text-sm font-medium">T·ªïng thu nh·∫≠p</p>
                <h3 id="incomeVal" class="number-style-report mt-1">0 ‚Ç´</h3>
            </div>

            <div class="stat-card">
                <div class="flex items-center justify-between mb-4">
                    <div class="bg-red-100 p-3 rounded-full">
                        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 13l-5 5m0 0l-5-5m5 5V6"></path>
                        </svg>
                    </div>
                    <span class="text-xs font-semibold text-red-600 bg-red-50 px-2 py-1 rounded">- Chi ti√™u</span>
                </div>
                <p class="text-gray-500 text-sm font-medium">T·ªïng chi ti√™u</p>
                <h3 id="expenseVal" class="number-style-report mt-1">0 ‚Ç´</h3>
            </div>

            <div class="stat-card">
                <div class="flex items-center justify-between mb-4">
                    <div class="bg-blue-100 p-3 rounded-full">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                            </path>
                        </svg>
                    </div>
                    <span class="text-xs font-semibold text-blue-600 bg-blue-50 px-2 py-1 rounded">Hi·ªán c√≥</span>
                </div>
                <p class="text-gray-500 text-sm font-medium">S·ªë d∆∞ kh·∫£ d·ª•ng</p>
                <h3 id="balanceVal" class="number-style-report mt-1">0 ‚Ç´</h3>
            </div>
        </section>

        <section class="main-chart-card">
            <div class="report-header" style="margin-bottom: 0;">
                <h3 style="font-size: 1.2rem; margin: 0;">D√≤ng ti·ªÅn</h3>
                <p style="margin: 0; font-size: 0.9rem; color: #64748b;">Thu nh·∫≠p vs Chi ti√™u <span
                        id="periodLabel">...</span></p>
            </div>
            <div class="chart-wrapper">
                <canvas id="flowChart"></canvas>
            </div>
        </section>

        <div class="bottom-grid">
            <div class="sub-card">
                <h3 style="font-size: 1.2rem; margin-bottom: 20px;">Ph√¢n lo·∫°i Chi ti√™u</h3>
                <div class="cat-list"></div>
            </div>
            <div class="sub-card">
                <h3 style="font-size: 1.2rem; margin-bottom: 20px;">Ph√¢n lo·∫°i Thu nh·∫≠p</h3>
                <div class="income-cat-list"></div>
            </div>
        </div>

        <section class="main-chart-card" style="margin-top: 24px;">
            <h3 style="font-size: 1.2rem; margin-bottom: 20px;">Giao d·ªãch g·∫ßn ƒë√¢y</h3>
            <div class="tx-list"></div>
        </section>
    </div>



    <script type="module">
        import { getStatsByDateRange } from '../../src/firebase/firestore.service.js';
        import { checkAuth } from '../../src/firebase/auth.js';
        import { normalizeCategory, getCategoryInfo } from '../../src/js/categoryUtils.js';
        import { formatCurrency, getExchangeRate } from '../../src/services/currencyService.js';
        import { DateRangePicker } from '../../src/js/components/dateRangePicker.js';

        let myChart;
        let currentRate = null; // Cached exchange rate
        let picker = null;

        // Helper to get current currency code
        function getCurrentCurrencyCode() {
            return localStorage.getItem('moneykeeper_currency') || 'VND';
        }

        // Helper: Convert VND to selected currency for charts
        function convertAmount(amountVND) {
            const currency = getCurrentCurrencyCode();
            if (currency === 'USD' && currentRate) {
                return amountVND / currentRate;
            }
            return amountVND;
        }

        // --- SETUP CHART ---
        function initChart() {
            const ctx = document.getElementById('flowChart').getContext('2d');
            const greenGradient = ctx.createLinearGradient(0, 0, 0, 300);
            greenGradient.addColorStop(0, 'rgba(16, 185, 129, 0.2)');
            greenGradient.addColorStop(1, 'rgba(16, 185, 129, 0)');

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Thu nh·∫≠p', data: [], borderColor: '#10b981', backgroundColor: greenGradient, fill: true, tension: 0.4
                    }, {
                        label: 'Chi ti√™u', data: [], borderColor: '#ef4444', fill: false, tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1500,
                        easing: 'easeOutQuart'
                    },
                    scales: { y: { display: false }, x: { grid: { display: false } } },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const currency = getCurrentCurrencyCode();
                                    const isUSD = currency === 'USD';
                                    const val = context.raw;

                                    // Convert back to VND for passing to formatCurrency
                                    const vndValue = isUSD ? val * currentRate : val;
                                    return context.dataset.label + ': ' + formatCurrency(vndValue, null, currentRate);
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- FETCH & PROCESS DATA ---
        async function loadData(startDate, endDate) {
            // Update Labels
            const startStr = startDate.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' });
            const endStr = endDate.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
            document.getElementById('periodLabel').innerText = `${startStr} - ${endStr}`;

            try {
                const data = await getStatsByDateRange(startDate, endDate);

                // Update Stats (s·ª≠ d·ª•ng formatCurrency ƒë·ªÉ h·ªó tr·ª£ VND/USD)
                document.getElementById('incomeVal').innerText = formatCurrency(data.totalIncome, null, currentRate);
                document.getElementById('expenseVal').innerText = formatCurrency(data.totalExpense, null, currentRate);
                document.getElementById('balanceVal').innerText = formatCurrency(data.balance, null, currentRate);

                // Build daily data
                // Calculate number of days
                const diffTime = Math.abs(endDate - startDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;

                // Initialize map for all dates in range
                const incomeByDate = new Map();
                const expenseByDate = new Map();
                const labels = [];

                for (let i = 0; i < diffDays; i++) {
                    const d = new Date(startDate);
                    d.setDate(d.getDate() + i);

                    // Key format YYYY-MM-DD
                    const year = d.getFullYear();
                    const month = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    const key = `${year}-${month}-${day}`;

                    incomeByDate.set(key, 0);
                    expenseByDate.set(key, 0);
                    labels.push(`${day}/${month}`);
                }

                data.transactions.forEach(t => {
                    // t.date is YYYY-MM-DD
                    if (incomeByDate.has(t.date)) {
                        if (t.type === 'income') incomeByDate.set(t.date, incomeByDate.get(t.date) + t.amount);
                        else expenseByDate.set(t.date, expenseByDate.get(t.date) + t.amount);
                    }
                });

                // Update chart
                myChart.data.labels = labels;
                myChart.data.datasets[0].data = Array.from(incomeByDate.values()).map(v => convertAmount(v));
                myChart.data.datasets[1].data = Array.from(expenseByDate.values()).map(v => convertAmount(v));
                myChart.update();

                // Render Categories & Transactions
                renderCategories(data.transactions, data.totalExpense);
                renderIncomeCategories(data.transactions, data.totalIncome);
                renderTransactions(data.transactions);

            } catch (error) {
                console.error("Error loading report data:", error);
            }
        }

        function renderCategories(txs, total) {
            const container = document.querySelector('.cat-list'); container.innerHTML = '';
            if (total === 0) { container.innerHTML = '<p style="color:#999; text-align:center; padding: 20px;">Ch∆∞a c√≥ chi ti√™u</p>'; return; }

            // S·ª≠ d·ª•ng categoryUtils ƒë·ªÉ chu·∫©n h√≥a v√† nh√≥m theo category
            const sums = {};
            txs.filter(t => t.type === 'expense').forEach(t => {
                const normalizedName = normalizeCategory(t.category, 'expense');
                const categoryInfo = getCategoryInfo(t.category, 'expense');
                if (!sums[normalizedName]) {
                    sums[normalizedName] = { amount: 0, color: categoryInfo.color };
                }
                sums[normalizedName].amount += t.amount;
            });

            Object.entries(sums).sort((a, b) => b[1].amount - a[1].amount).forEach(([name, data]) => {
                const pct = Math.round((data.amount / total) * 100);
                const hexColor = data.color;

                container.innerHTML += `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-1 text-sm">
                            <span class="flex items-center gap-2 font-medium text-slate-700">
                                <span class="w-2 h-2 rounded-full" style="background-color: ${hexColor}"></span> ${name}
                            </span>
                            <span class="text-slate-500 font-medium">${formatCurrency(data.amount, null, currentRate)} <b class="text-slate-800 ml-1">${pct}%</b></span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-1.5 overflow-hidden">
                            <div class="h-full rounded-full" style="width: ${pct}%; background-color: ${hexColor}"></div>
                        </div>
                    </div>`;
            });
        }

        function renderIncomeCategories(txs, total) {
            const container = document.querySelector('.income-cat-list'); container.innerHTML = '';
            if (total === 0) { container.innerHTML = '<p style="color:#999; text-align:center; padding: 20px;">Ch∆∞a c√≥ thu nh·∫≠p</p>'; return; }

            // Group by income category
            const sums = {};
            txs.filter(t => t.type === 'income').forEach(t => {
                const normalizedName = normalizeCategory(t.category, 'income');
                const categoryInfo = getCategoryInfo(t.category, 'income');
                if (!sums[normalizedName]) {
                    sums[normalizedName] = { amount: 0, color: categoryInfo.color };
                }
                sums[normalizedName].amount += t.amount;
            });

            Object.entries(sums).sort((a, b) => b[1].amount - a[1].amount).forEach(([name, data]) => {
                const pct = Math.round((data.amount / total) * 100);
                const hexColor = data.color;

                container.innerHTML += `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-1 text-sm">
                            <span class="flex items-center gap-2 font-medium text-slate-700">
                                <span class="w-2 h-2 rounded-full" style="background-color: ${hexColor}"></span> ${name}
                            </span>
                            <span class="text-slate-500 font-medium">${formatCurrency(data.amount, null, currentRate)} <b class="text-slate-800 ml-1">${pct}%</b></span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-1.5 overflow-hidden">
                            <div class="h-full rounded-full" style="width: ${pct}%; background-color: ${hexColor}"></div>
                        </div>
                    </div>`;
            });
        }

        function renderTransactions(txs) {
            const container = document.querySelector('.tx-list'); container.innerHTML = '';
            if (txs.length === 0) container.innerHTML = '<p style="color:#999; text-align:center; padding: 20px;">Ch∆∞a c√≥ giao d·ªãch</p>';

            txs.slice(0, 5).forEach(t => {
                const isExp = t.type !== 'income';
                const dateParts = t.date.split('-');
                const displayDate = `${dateParts[2]}/${dateParts[1]}`;
                const amountClass = isExp ? 'text-red-500' : 'text-green-500';
                const sign = isExp ? '-' : '+';

                container.innerHTML += `
                    <div class="flex items-center justify-between p-3 mb-2 bg-slate-50 rounded-lg last:mb-0 hover:bg-slate-100 transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-lg shadow-sm">
                                ${isExp ? 'üõí' : 'üí∞'}
                            </div>
                            <div class="flex flex-col">
                                <strong class="text-sm text-slate-700 font-semibold">${t.note || t.category}</strong>
                                <span class="text-xs text-slate-400 font-medium">${displayDate}</span>
                            </div>
                        </div>
                        <span class="font-bold text-sm ${amountClass}">${sign} ${formatCurrency(t.amount, null, currentRate)}</span>
                    </div>`;
            });
        }

        // --- INITIALIZE ---
        document.addEventListener('DOMContentLoaded', async () => {
            const user = await checkAuth();
            if (!user) return;

            // Pre-load exchange rate
            currentRate = await getExchangeRate();

            initChart();

            // Init Date Picker
            picker = new DateRangePicker('report-date-picker', {
                onApply: (start, end) => {
                    loadData(start, end);
                }
            });

            // Initial load with picker's default date (This Month)
            loadData(picker.startDate, picker.endDate);
        });
    </script>


    <script type="module">
        import { loadHeader } from '../../src/js/headerLoader.js';
        document.addEventListener('DOMContentLoaded', () => {
            loadHeader('/quanlychitieu/components/header.html');
        });
    </script>
    <script type="module" src="../../src/js/logout.js"></script>
</body>

</html>